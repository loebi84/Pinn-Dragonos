name: Update DragonOS weekly

on:
  schedule:
    - cron: '0 3 * * 1'  # Jeden Montag um 03:00 UTC
  workflow_dispatch:

jobs:
  update-dragonos:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Repo klonen
        uses: actions/checkout@v3

      - name: ğŸ§  DragonOS-Link dynamisch holen
        id: get-dragonos
        run: |
          echo "ğŸ“¡ RSS-Feed wird analysiertâ€¦"
          feed_url="https://sourceforge.net/projects/dragonos/rss?path=/DragonOS_Pi64"
          latest_url=$(curl -s "$feed_url" | grep -oP 'url="\\Khttps://.*?\\.img\\.xz(?=")' | head -n 1)

          if [ -z "$latest_url" ]; then
            echo "âŒ Kein Download-Link gefunden!"
            exit 1
          fi

          echo "âœ… Gefundener Link: $latest_url"
          echo "dragonos_url=$latest_url" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ DragonOS herunterladen
        run: |
          echo "ğŸ“¦ Lade DragonOS von: ${{ steps.get-dragonos.outputs.dragonos_url }}"
          wget -O dragonos.img.xz "${{ steps.get-dragonos.outputs.dragonos_url }}"

      - name: ğŸ”§ Split & Convert .img â†’ .tar.xz
        run: |
          chmod +x split_and_convert.sh
          ./split_and_convert.sh

      - name: â¬†ï¸ Push ins Repo
        run: |
          git config user.name "LÃ¶biBot"
          git config user.email "bot@dragonos.local"
          git add boot.tar.xz root.tar.xz
          git commit -m "ğŸ‰ Weekly DragonOS update ($(date +'%Y-%m-%d'))"
          git push
